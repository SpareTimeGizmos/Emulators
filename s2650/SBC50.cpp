//++
// SBC50.cpp - Signetics 2650 Emulator main program
//
// DESCRIPTION:
//   This file is the main program for the 2650 Emulator task.  
//
// LIMITATIONS (aka the TO DO list)
//
//                                  Bob Armstrong [22-FEB-20]
//
// REVISION HISTORY:
// 22-FEB-20  RLA   New file.
//--
//000000001111111111222222222233333333334444444444555555555566666666667777777777
//234567890123456789012345678901234567890123456789012345678901234567890123456789
#include <stdlib.h>             // exit(), system(), etc ...
#include <stdint.h>	        // uint8_t, uint32_t, etc ...
#include <assert.h>             // assert() (what else??)
#include "EMULIB.hpp"           // emulator library definitions
#include "ConsoleWindow.hpp"    // emulator console window methods
#include "LogFile.hpp"          // emulator library message logging facility
#include "ImageFile.hpp"        // emulator library image file methods
#include "CommandParser.hpp"    // emulator library command line parsing methods
#include "CommandLine.hpp"      // emulator library shell (argc/argv) parser methods
#include "StandardUI.hpp"       // emulator library standard UI commands
#include "SBC50.hpp"            // global declarations for this project
#include "Interrupt.hpp"        // interrupt simulation logic
#include "EventQueue.hpp"       // I/O device event queue simulation
#include "MemoryTypes.h"        // address_t and word_t data types
#include "Memory.hpp"           // main memory emulation
#include "CPU.hpp"              // CCPU base class definitions
#include "S2650.hpp"            // 2650 CPU emulation
#include "Device.hpp"           // CDevice I/O device emulation objects
#include "SoftwareSerial.hpp"   // software serial port
#include "S2651.hpp"            // 2651 UART emulation
#include "UserInterface.hpp"    // User interface parse table definitions


// Global objects ....
//   These objects are used (more or less) everywhere within this program, and
// you'll find "extern ..." declarations for them in SBC50.hpp.  Note that they
// are declared as pointers rather than the actual objects because we want
// to control the exact order in which they're created and destroyed!
CConsoleWindow  *g_pConsole     = NULL; // console window object
CLog            *g_pLog         = NULL; // message logging object (including console!)
CCmdParser      *g_pParser      = NULL; // command line parser
// These globals point to the objects being emulated ...
CGenericMemory  *g_pMemory      = NULL; // memory emulat-ion
CEventQueue     *g_pEvents      = NULL; // list of things to do next
C2650           *g_pCPU         = NULL; // 2650 CPU
CSoftwareSerial *g_pSerial      = NULL; // software serial port
C2651           *g_pSLU0        = NULL; // console UART


#ifdef PIPBUG
void ROMW (address_t a, uint8_t b1) {g_pMemory->UIwrite(a, b1);}
void ROMW (address_t a, uint8_t b1, uint8_t b2) {g_pMemory->UIwrite(a, b1); ROMW(a+1, b2);}
void ROMW (address_t a, uint8_t b1, uint8_t b2, uint8_t b3) {g_pMemory->UIwrite(a, b1); ROMW(a+1, b2, b3);}
void ROMW (address_t a, uint8_t b1, uint8_t b2, uint8_t b3, uint8_t b4) {g_pMemory->UIwrite(a, b1); ROMW(a+1, b2, b3, b4);}

void LoadPIPBUG()
{
  ROMW(0x0000, 0x07, 0x3f);
  ROMW(0x0002, 0x20);
  ROMW(0x0003, 0xcf, 0x44, 0x00);
  ROMW(0x0006, 0x5b, 0x7b);
  ROMW(0x0008, 0x04, 0x77);
  ROMW(0x000a, 0xcc, 0x04, 0x09);
  ROMW(0x000d, 0x04, 0x1b);
  ROMW(0x000f, 0xcc, 0x04, 0x0b);
  ROMW(0x0012, 0x04, 0x80);
  ROMW(0x0014, 0xcc, 0x04, 0x0c);
  ROMW(0x0017, 0x1b, 0x09);
  ROMW(0x0019, 0x01, 0x60);
  ROMW(0x001b, 0x01, 0x6e);
  ROMW(0x001d, 0x04, 0x3f);
  ROMW(0x001f, 0x3f, 0x02, 0xb4);
  ROMW(0x0022, 0x75, 0xff);
  ROMW(0x0024, 0x3f, 0x00, 0x8a);
  ROMW(0x0027, 0x04, 0x2a);
  ROMW(0x0029, 0x3f, 0x02, 0xb4);
  ROMW(0x002c, 0x3b, 0x2d);
  ROMW(0x002e, 0x20);
  ROMW(0x002f, 0xcc, 0x04, 0x27);
  ROMW(0x0032, 0x0c, 0x04, 0x13);
  ROMW(0x0035, 0xe4, 0x41);
  ROMW(0x0037, 0x1c, 0x00, 0xab);
  ROMW(0x003a, 0xe4, 0x42);
  ROMW(0x003c, 0x1c, 0x01, 0xe5);
  ROMW(0x003f, 0xe4, 0x43);
  ROMW(0x0041, 0x1c, 0x01, 0xca);
  ROMW(0x0044, 0xe4, 0x44);
  ROMW(0x0046, 0x1c, 0x03, 0x10);
  ROMW(0x0049, 0xe4, 0x47);
  ROMW(0x004b, 0x1c, 0x01, 0x3a);
  ROMW(0x004e, 0xe4, 0x4c);
  ROMW(0x0050, 0x1c, 0x03, 0xb5);
  ROMW(0x0053, 0xe4, 0x53);
  ROMW(0x0055, 0x1c, 0x00, 0xf4);
  ROMW(0x0058, 0x1f, 0x00, 0x1d);
  ROMW(0x005b, 0x07, 0xff);
  ROMW(0x005d, 0xcf, 0x04, 0x27);
  ROMW(0x0060, 0xe7, 0x14);
  ROMW(0x0062, 0x18, 0x19);
  ROMW(0x0064, 0x3f, 0x02, 0x86);
  ROMW(0x0067, 0xe4, 0x7f);
  ROMW(0x0069, 0x98, 0x0e);
  ROMW(0x006b, 0xe7, 0xff);
  ROMW(0x006d, 0x18, 0x71);
  ROMW(0x006f, 0x0f, 0x64, 0x13);
  ROMW(0x0072, 0x3f, 0x02, 0xb4);
  ROMW(0x0075, 0xa7, 0x01);
  ROMW(0x0077, 0x1b, 0x67);
  ROMW(0x0079, 0xe4, 0x0d);
  ROMW(0x007b, 0x98, 0x18);
  ROMW(0x007d, 0x05, 0x01);
  ROMW(0x007f, 0x03);
  ROMW(0x0080, 0x1a, 0x02);
  ROMW(0x0082, 0x85, 0x02);
  ROMW(0x0084, 0xcd, 0x04, 0x2a);
  ROMW(0x0087, 0xcf, 0x04, 0x29);
  ROMW(0x008a, 0x04, 0x0d);
  ROMW(0x008c, 0x3f, 0x02, 0xb4);
  ROMW(0x008f, 0x04, 0x0a);
  ROMW(0x0091, 0x3f, 0x02, 0xb4);
  ROMW(0x0094, 0x17);
  ROMW(0x0095, 0x05, 0x02);
  ROMW(0x0097, 0xe4, 0x0a);
  ROMW(0x0099, 0x18, 0x64);
  ROMW(0x009b, 0xcf, 0x24, 0x13);
  ROMW(0x009e, 0x3f, 0x02, 0xb4);
  ROMW(0x00a1, 0x1f, 0x00, 0x60);
  ROMW(0x00a4, 0xcd, 0x04, 0x0d);
  ROMW(0x00a7, 0xce, 0x04, 0x0e);
  ROMW(0x00aa, 0x17);
  ROMW(0x00ab, 0x3f, 0x02, 0xdb);
  ROMW(0x00ae, 0x3b, 0x74);
  ROMW(0x00b0, 0x3f, 0x02, 0x69);
  ROMW(0x00b3, 0x0d, 0x04, 0x0e);
  ROMW(0x00b6, 0x3f, 0x02, 0x69);
  ROMW(0x00b9, 0x3f, 0x03, 0x5b);
  ROMW(0x00bc, 0x0d, 0x84, 0x0d);
  ROMW(0x00bf, 0x3f, 0x02, 0x69);
  ROMW(0x00c2, 0x3f, 0x03, 0x5b);
  ROMW(0x00c5, 0x3f, 0x00, 0x5b);
  ROMW(0x00c8, 0x0c, 0x04, 0x2a);
  ROMW(0x00cb, 0xe4, 0x02);
  ROMW(0x00cd, 0x1e, 0x00, 0x22);
  ROMW(0x00d0, 0x18, 0x11);
  ROMW(0x00d2, 0xcc, 0x04, 0x11);
  ROMW(0x00d5, 0x3f, 0x02, 0xdb);
  ROMW(0x00d8, 0xce, 0x84, 0x0d);
  ROMW(0x00db, 0x0c, 0x04, 0x11);
  ROMW(0x00de, 0xe4, 0x04);
  ROMW(0x00e0, 0x9c, 0x00, 0x22);
  ROMW(0x00e3, 0x06, 0x01);
  ROMW(0x00e5, 0x8e, 0x04, 0x0e);
  ROMW(0x00e8, 0x05, 0x00);
  ROMW(0x00ea, 0x77, 0x08);
  ROMW(0x00ec, 0x8d, 0x04, 0x0d);
  ROMW(0x00ef, 0x75, 0x08);
  ROMW(0x00f1, 0x1f, 0x00, 0xae);
  ROMW(0x00f4, 0x3f, 0x02, 0xdb);
  ROMW(0x00f7, 0xe6, 0x08);
  ROMW(0x00f9, 0x1d, 0x00, 0x1d);
  ROMW(0x00fc, 0xce, 0x04, 0x11);
  ROMW(0x00ff, 0x0e, 0x64, 0x00);
  ROMW(0x0102, 0xc1);
  ROMW(0x0103, 0x3f, 0x02, 0x69);
  ROMW(0x0106, 0x3f, 0x03, 0x5b);
  ROMW(0x0109, 0x3f, 0x00, 0x5b);
  ROMW(0x010c, 0x0c, 0x04, 0x2a);
  ROMW(0x010f, 0xe4, 0x02);
  ROMW(0x0111, 0x1e, 0x00, 0x22);
  ROMW(0x0114, 0x18, 0x1c);
  ROMW(0x0116, 0xcc, 0x04, 0x0f);
  ROMW(0x0119, 0x3f, 0x02, 0xdb);
  ROMW(0x011c, 0x02);
  ROMW(0x011d, 0x0e, 0x04, 0x11);
  ROMW(0x0120, 0xce, 0x64, 0x00);
  ROMW(0x0123, 0xe6, 0x08);
  ROMW(0x0125, 0x98, 0x03);
  ROMW(0x0127, 0xcc, 0x04, 0x0a);
  ROMW(0x012a, 0x0c, 0x04, 0x0f);
  ROMW(0x012d, 0xe4, 0x03);
  ROMW(0x012f, 0x1c, 0x00, 0x22);
  ROMW(0x0132, 0x0e, 0x04, 0x11);
  ROMW(0x0135, 0x86, 0x01);
  ROMW(0x0137, 0x1f, 0x00, 0xf7);
  ROMW(0x013a, 0x3f, 0x02, 0xdb);
  ROMW(0x013d, 0x3f, 0x00, 0xa4);
  ROMW(0x0140, 0x0c, 0x04, 0x07);
  ROMW(0x0143, 0x92);
  ROMW(0x0144, 0x0d, 0x04, 0x01);
  ROMW(0x0147, 0x0e, 0x04, 0x02);
  ROMW(0x014a, 0x0f, 0x04, 0x03);
  ROMW(0x014d, 0x77, 0x10);
  ROMW(0x014f, 0x0d, 0x04, 0x04);
  ROMW(0x0152, 0x0e, 0x04, 0x05);
  ROMW(0x0155, 0x0f, 0x04, 0x06);
  ROMW(0x0158, 0x0c, 0x04, 0x00);
  ROMW(0x015b, 0x75, 0xff);
  ROMW(0x015d, 0x1f, 0x04, 0x09);
  ROMW(0x0160, 0xcc, 0x04, 0x00);
  ROMW(0x0163, 0x13);
  ROMW(0x0164, 0xcc, 0x04, 0x08);
  ROMW(0x0167, 0xcc, 0x04, 0x0a);
  ROMW(0x016a, 0x04, 0x00);
  ROMW(0x016c, 0x1b, 0x0c);
  ROMW(0x016e, 0xcc, 0x04, 0x00);
  ROMW(0x0171, 0x13);
  ROMW(0x0172, 0xcc, 0x04, 0x08);
  ROMW(0x0175, 0xcc, 0x04, 0x0a);
  ROMW(0x0178, 0x04, 0x01);
  ROMW(0x017a, 0xcc, 0x04, 0x11);
  ROMW(0x017d, 0x12);
  ROMW(0x017e, 0xcc, 0x04, 0x07);
  ROMW(0x0181, 0x77, 0x10);
  ROMW(0x0183, 0xcd, 0x04, 0x04);
  ROMW(0x0186, 0xce, 0x04, 0x05);
  ROMW(0x0189, 0xcf, 0x04, 0x06);
  ROMW(0x018c, 0x75, 0x18);
  ROMW(0x018e, 0xcd, 0x04, 0x01);
  ROMW(0x0191, 0xce, 0x04, 0x02);
  ROMW(0x0194, 0xcf, 0x04, 0x03);
  ROMW(0x0197, 0x0e, 0x04, 0x11);
  ROMW(0x019a, 0x3b, 0x0f);
  ROMW(0x019c, 0x0d, 0x04, 0x0d);
  ROMW(0x019f, 0x3f, 0x02, 0x69);
  ROMW(0x01a2, 0x0d, 0x04, 0x0e);
  ROMW(0x01a5, 0x3f, 0x02, 0x69);
  ROMW(0x01a8, 0x1f, 0x00, 0x22);
  ROMW(0x01ab, 0x20);
  ROMW(0x01ac, 0xce, 0x64, 0x2d);
  ROMW(0x01af, 0x0e, 0x64, 0x33);
  ROMW(0x01b2, 0xcc, 0x04, 0x0d);
  ROMW(0x01b5, 0x0e, 0x64, 0x35);
  ROMW(0x01b8, 0xcc, 0x04, 0x0e);
  ROMW(0x01bb, 0x0e, 0x64, 0x2f);
  ROMW(0x01be, 0xcc, 0x84, 0x0d);
  ROMW(0x01c1, 0x0e, 0x64, 0x31);
  ROMW(0x01c4, 0x07, 0x01);
  ROMW(0x01c6, 0xcf, 0xe4, 0x0d);
  ROMW(0x01c9, 0x17);
  ROMW(0x01ca, 0x3b, 0x0b);
  ROMW(0x01cc, 0x0e, 0x64, 0x2d);
  ROMW(0x01cf, 0x1c, 0x00, 0x1d);
  ROMW(0x01d2, 0x3b, 0x57);
  ROMW(0x01d4, 0x1f, 0x00, 0x22);
  ROMW(0x01d7, 0x3f, 0x02, 0xdb);
  ROMW(0x01da, 0xa6, 0x01);
  ROMW(0x01dc, 0x1e, 0x02, 0x50);
  ROMW(0x01df, 0xe6, 0x01);
  ROMW(0x01e1, 0x1d, 0x02, 0x50);
  ROMW(0x01e4, 0x17);
  ROMW(0x01e5, 0x3b, 0x70);
  ROMW(0x01e7, 0x0e, 0x64, 0x2d);
  ROMW(0x01ea, 0xbc, 0x01, 0xab);
  ROMW(0x01ed, 0xce, 0x04, 0x11);
  ROMW(0x01f0, 0x3f, 0x02, 0xdb);
  ROMW(0x01f3, 0x3f, 0x00, 0xa4);
  ROMW(0x01f6, 0x0f, 0x04, 0x11);
  ROMW(0x01f9, 0x02);
  ROMW(0x01fa, 0xcf, 0x64, 0x35);
  ROMW(0x01fd, 0x01);
  ROMW(0x01fe, 0xcf, 0x64, 0x33);
  ROMW(0x0201, 0x0c, 0x84, 0x0d);
  ROMW(0x0204, 0xcf, 0x64, 0x2f);
  ROMW(0x0207, 0x05, 0x9b);
  ROMW(0x0209, 0xcd, 0x84, 0x0d);
  ROMW(0x020c, 0x06, 0x01);
  ROMW(0x020e, 0x0e, 0xe4, 0x0d);
  ROMW(0x0211, 0xcf, 0x64, 0x31);
  ROMW(0x0214, 0x0f, 0x62, 0x22);
  ROMW(0x0217, 0xce, 0xe4, 0x0d);
  ROMW(0x021a, 0x04, 0xff);
  ROMW(0x021c, 0xcf, 0x64, 0x2d);
  ROMW(0x021f, 0x1f, 0x00, 0x22);
  ROMW(0x0222, 0x99);
  ROMW(0x0223, 0x9b);
  ROMW(0x0224, 0x3f, 0x02, 0x86);
  ROMW(0x0227, 0x3b, 0x1d);
  ROMW(0x0229, 0xd3);
  ROMW(0x022a, 0xd3);
  ROMW(0x022b, 0xd3);
  ROMW(0x022c, 0xd3);
  ROMW(0x022d, 0xcf, 0x04, 0x12);
  ROMW(0x0230, 0x3f, 0x02, 0x86);
  ROMW(0x0233, 0x3b, 0x11);
  ROMW(0x0235, 0x6f, 0x04, 0x12);
  ROMW(0x0238, 0x03);
  ROMW(0x0239, 0xc1);
  ROMW(0x023a, 0x3b, 0x01);
  ROMW(0x023c, 0x17);
  ROMW(0x023d, 0x01);
  ROMW(0x023e, 0x2c, 0x04, 0x2c);
  ROMW(0x0241, 0xd0);
  ROMW(0x0242, 0xcc, 0x04, 0x2c);
  ROMW(0x0245, 0x17);
  ROMW(0x0246, 0x07, 0x10);
  ROMW(0x0248, 0xef, 0x42, 0x59);
  ROMW(0x024b, 0x14);
  ROMW(0x024c, 0xe7, 0x01);
  ROMW(0x024e, 0x9a, 0x78);
  ROMW(0x0250, 0x0c, 0x04, 0x07);
  ROMW(0x0253, 0x64, 0x40);
  ROMW(0x0255, 0x92);   // LPSU - was SPSU 0x12
  ROMW(0x0256, 0x1f, 0x00, 0x1d);
  ROMW(0x0259, 0x30, 0x31, 0x32, 0x33);
  ROMW(0x025d, 0x34, 0x35, 0x36, 0x37);
  ROMW(0x0261, 0x38, 0x39, 0x41, 0x42);
  ROMW(0x0265, 0x43, 0x44, 0x45, 0x46);
  ROMW(0x0269, 0xcd, 0x04, 0x12);
  ROMW(0x026c, 0x3b, 0x4f);
  ROMW(0x026e, 0x51);
  ROMW(0x026f, 0x51);
  ROMW(0x0270, 0x51);
  ROMW(0x0271, 0x51);
  ROMW(0x0272, 0x45, 0x0f);
  ROMW(0x0274, 0x0d, 0x62, 0x59);
  ROMW(0x0277, 0x3f, 0x02, 0xb4);
  ROMW(0x027a, 0x0d, 0x04, 0x12);
  ROMW(0x027d, 0x45, 0x0f);
  ROMW(0x027f, 0x0d, 0x62, 0x59);
  ROMW(0x0282, 0x3f, 0x02, 0xb4);
  ROMW(0x0285, 0x17);

  // CHIN
  ROMW(0x0286, 0x77, 0x10);
  ROMW(0x0288, 0x04, 0x80);
  ROMW(0x028a, 0xb0);
  ROMW(0x028b, 0x05, 0x00);
  ROMW(0x028d, 0x06, 0x08);
  ROMW(0x028f, 0x12);
  ROMW(0x0290, 0x1a, 0x74);
  ROMW(0x0292, 0x20);
  ROMW(0x0293, 0xb0);
  ROMW(0x0294, 0x3b, 0x17);
  ROMW(0x0296, 0x3b, 0x10);
  ROMW(0x0298, 0x12);
  ROMW(0x0299, 0x44, 0x80);
  ROMW(0x029b, 0x51);
  ROMW(0x029c, 0x61);
  ROMW(0x029d, 0xc1);
  ROMW(0x029e, 0xfa, 0x76);
  ROMW(0x02a0, 0x3b, 0x06);
  ROMW(0x02a2, 0x45, 0x7f);
  ROMW(0x02a4, 0x01);
  ROMW(0x02a5, 0x75, 0x18);
  ROMW(0x02a7, 0x17);

  // DLAY
  ROMW(0x02a8, 0x20);
  ROMW(0x02a9, 0xf8, 0x7e);
  ROMW(0x02ab, 0xf8, 0x7e);
  ROMW(0x02ad, 0xf8, 0x7e);
  ROMW(0x02af, 0x04, 0xe5);
  ROMW(0x02b1, 0xf8, 0x7e);
  ROMW(0x02b3, 0x17);

  // COUT
  ROMW(0x02b4, 0x77, 0x10);
  ROMW(0x02b6, 0x76, 0x40);
  ROMW(0x02b8, 0xc2);
  ROMW(0x02b9, 0x05, 0x08);
  ROMW(0x02bb, 0x3b, 0x6b);
  ROMW(0x02bd, 0x3b, 0x69);
  ROMW(0x02bf, 0x74, 0x40);
  ROMW(0x02c1, 0x3b, 0x65);
  ROMW(0x02c3, 0x52);
  ROMW(0x02c4, 0x1a, 0x04);
  ROMW(0x02c6, 0x74, 0x40);
  ROMW(0x02c8, 0x1b, 0x02);
  ROMW(0x02ca, 0x76, 0x40);
  ROMW(0x02cc, 0xf9, 0x73);
  ROMW(0x02ce, 0x3b, 0x58);
  ROMW(0x02d0, 0x76, 0x40);
  ROMW(0x02d2, 0x75, 0x10);
  ROMW(0x02d4, 0x17);

  ROMW(0x02d5, 0x0c, 0x04, 0x2a);
  ROMW(0x02d8, 0x18, 0x07);
  ROMW(0x02da, 0x17);
  ROMW(0x02db, 0x20);
  ROMW(0x02dc, 0xc1);
  ROMW(0x02dd, 0xc2);
  ROMW(0x02de, 0xcc, 0x04, 0x2a);
  ROMW(0x02e1, 0x0f, 0x04, 0x27);
  ROMW(0x02e4, 0xef, 0x04, 0x29);
  ROMW(0x02e7, 0x14);
  ROMW(0x02e8, 0x0f, 0x24, 0x13);
  ROMW(0x02eb, 0xcf, 0x04, 0x27);
  ROMW(0x02ee, 0xe4, 0x20);
  ROMW(0x02f0, 0x18, 0x63);
  ROMW(0x02f2, 0x3f, 0x02, 0x46);
  ROMW(0x02f5, 0x04, 0x0f);
  ROMW(0x02f7, 0xd2);
  ROMW(0x02f8, 0xd2);
  ROMW(0x02f9, 0xd2);
  ROMW(0x02fa, 0xd2);
  ROMW(0x02fb, 0x42);
  ROMW(0x02fc, 0xd1);
  ROMW(0x02fd, 0xd1);
  ROMW(0x02fe, 0xd1);
  ROMW(0x02ff, 0xd1);
  ROMW(0x0300, 0x45, 0xf0);
  ROMW(0x0302, 0x46, 0xf0);
  ROMW(0x0304, 0x61);
  ROMW(0x0305, 0xc1);
  ROMW(0x0306, 0x03);
  ROMW(0x0307, 0x62);
  ROMW(0x0308, 0xc2);
  ROMW(0x0309, 0x04, 0x01);
  ROMW(0x030b, 0xcc, 0x04, 0x2a);
  ROMW(0x030e, 0x1b, 0x51);
  ROMW(0x0310, 0x3b, 0x49);
  ROMW(0x0312, 0x3f, 0x00, 0xa4);
  ROMW(0x0315, 0x3b, 0x44);
  ROMW(0x0317, 0x86, 0x01);
  ROMW(0x0319, 0x77, 0x08);
  ROMW(0x031b, 0x85, 0x00);
  ROMW(0x031d, 0x75, 0x08);
  ROMW(0x031f, 0xcd, 0x04, 0x0f);
  ROMW(0x0322, 0xce, 0x04, 0x10);
  ROMW(0x0325, 0x3b, 0x38);
  ROMW(0x0327, 0x04, 0xff);
  ROMW(0x0329, 0xcc, 0x04, 0x29);
  ROMW(0x032c, 0x3f, 0x00, 0x8a);
  ROMW(0x032f, 0x04, 0x3a);
  ROMW(0x0331, 0x3f, 0x02, 0xb4);
  ROMW(0x0334, 0x20);
  ROMW(0x0335, 0xcc, 0x04, 0x2c);
  ROMW(0x0338, 0x0d, 0x04, 0x0f);
  ROMW(0x033b, 0x0e, 0x04, 0x10);
  ROMW(0x033e, 0xae, 0x04, 0x0e);
  ROMW(0x0341, 0x77, 0x08);
  ROMW(0x0343, 0xad, 0x04, 0x0d);
  ROMW(0x0346, 0x75, 0x08);
  ROMW(0x0348, 0x1e, 0x00, 0x1d);
  ROMW(0x034b, 0x19, 0x1c);
  ROMW(0x034d, 0x5a, 0x1c);
  ROMW(0x034f, 0x07, 0x04);
  ROMW(0x0351, 0x3f, 0x02, 0x69);
  ROMW(0x0354, 0xfb, 0x7b);
  ROMW(0x0356, 0x3b, 0x07);
  ROMW(0x0358, 0x1f, 0x00, 0x22);
  ROMW(0x035b, 0x07, 0x03);
  ROMW(0x035d, 0x1b, 0x02);
  ROMW(0x035f, 0x07, 0x32);
  ROMW(0x0361, 0x04, 0x20);
  ROMW(0x0363, 0x3f, 0x02, 0xb4);
  ROMW(0x0366, 0xfb, 0x79);
  ROMW(0x0368, 0x17);
  ROMW(0x0369, 0x06, 0xff);
  ROMW(0x036b, 0xce, 0x04, 0x28);
  ROMW(0x036e, 0x0d, 0x04, 0x0d);
  ROMW(0x0371, 0x3f, 0x02, 0x69);
  ROMW(0x0374, 0x0d, 0x04, 0x0e);
  ROMW(0x0377, 0x3f, 0x02, 0x69);
  ROMW(0x037a, 0x0d, 0x04, 0x28);
  ROMW(0x037d, 0x3f, 0x02, 0x69);
  ROMW(0x0380, 0x0d, 0x04, 0x2c);
  ROMW(0x0383, 0x3f, 0x02, 0x69);
  ROMW(0x0386, 0x0f, 0x04, 0x29);
  ROMW(0x0389, 0x0f, 0xa4, 0x0d);
  ROMW(0x038c, 0xef, 0x04, 0x28);
  ROMW(0x038f, 0x18, 0x09);
  ROMW(0x0391, 0xcf, 0x04, 0x29);
  ROMW(0x0394, 0xc1);
  ROMW(0x0395, 0x3f, 0x02, 0x69);
  ROMW(0x0398, 0x1b, 0x6c);
  ROMW(0x039a, 0x0d, 0x04, 0x2c);
  ROMW(0x039d, 0x3f, 0x02, 0x69);
  ROMW(0x03a0, 0x0e, 0x04, 0x0e);
  ROMW(0x03a3, 0x8e, 0x04, 0x28);
  ROMW(0x03a6, 0x05, 0x00);
  ROMW(0x03a8, 0x77, 0x08);
  ROMW(0x03aa, 0x8d, 0x04, 0x0d);
  ROMW(0x03ad, 0x75, 0x08);
  ROMW(0x03af, 0x3f, 0x00, 0xa4);
  ROMW(0x03b2, 0x1f, 0x03, 0x25);
  ROMW(0x03b5, 0x3f, 0x02, 0x86);
  ROMW(0x03b8, 0xe4, 0x3a);
  ROMW(0x03ba, 0x98, 0x79);
  ROMW(0x03bc, 0x20);
  ROMW(0x03bd, 0xcc, 0x04, 0x2c);
  ROMW(0x03c0, 0x3f, 0x02, 0x24);
  ROMW(0x03c3, 0xcd, 0x04, 0x0d);
  ROMW(0x03c6, 0x3f, 0x02, 0x24);
  ROMW(0x03c9, 0xcd, 0x04, 0x0e);
  ROMW(0x03cc, 0x3f, 0x02, 0x24);
  ROMW(0x03cf, 0x59, 0x03);
  ROMW(0x03d1, 0x1f, 0x84, 0x0d);
  ROMW(0x03d4, 0xcd, 0x04, 0x28);
  ROMW(0x03d7, 0x3f, 0x02, 0x24);
  ROMW(0x03da, 0x0c, 0x04, 0x2c);
  ROMW(0x03dd, 0x9c, 0x00, 0x1d);
  ROMW(0x03e0, 0xc3);
  ROMW(0x03e1, 0xcf, 0x04, 0x29);
  ROMW(0x03e4, 0x3f, 0x02, 0x24);
  ROMW(0x03e7, 0x0f, 0x04, 0x29);
  ROMW(0x03ea, 0xef, 0x04, 0x28);
  ROMW(0x03ed, 0x18, 0x06);
  ROMW(0x03ef, 0x01);
  ROMW(0x03f0, 0xcf, 0xe4, 0x0d);
  ROMW(0x03f3, 0xdb, 0x6c);
  ROMW(0x03f5, 0x0c, 0x04, 0x2c);
  ROMW(0x03f8, 0x9c, 0x00, 0x1d);
  ROMW(0x03fb, 0x1f, 0x03, 0xb5);
  ROMW(0x03fe, 0x40);
  ROMW(0x03ff, 0x40);
}
#endif


static bool ConfirmExit (CCmdParser &cmd)
{
  //++
  //   This routine is called whenever this application has been requested
  // to exit.  It returns true if we really should exit and false if we
  // shouldn't right now.
  //--
  return true;
}

int main (int argc, char *argv[])
{
  //++
  // Here's the main program for the 2650 Emulator .
  //--

  //   The very first thing is to create and initialize the console window
  // object, and after that we create and initialize the log object.  We
  // can't issue any error messages until we done these two things!
  g_pConsole = DBGNEW CConsoleWindow();
  g_pLog = DBGNEW CLog(PROGRAM, g_pConsole);

  //   Parse the command options.  Note that we want to do this BEFORE we
  // setup the console window, since the command line may tell us to detach
  // and create a new window...
  if (!CStandardUI::ParseOptions(PROGRAM, argc, argv)) goto shutdown;

  //   Set the console window defaults - foreground and background color,
  // scrolling buffer size, title, and icon ...
  g_pConsole->SetTitle("2650 Emulator v%d", SBC50VER);
  g_pConsole->SetBufferSize(132, 2000);
  g_pConsole->SetWindowSize(132, 40);
  g_pConsole->SetColors(CConsoleWindow::GREEN, CConsoleWindow::BLACK);
  g_pLog->SetDefaultConsoleLevel(CLog::WARNING);

  // We're finally ready to say hello ...
  CMDOUTF("2650 Emulator v%d emulator Library v%d", SBC50VER, EMUVER);
  CMDOUTS("Built on " << __DATE__ << " " << __TIME__);

  // Create the emulated CPU, memory and peripheral devices ...
  g_pEvents = DBGNEW CEventQueue();
  g_pMemory = DBGNEW CGenericMemory(C2650::MAXMEMORY);
  g_pMemory->SetRAM();
  g_pCPU = DBGNEW C2650(g_pMemory, g_pEvents);
  g_pSLU0 = DBGNEW C2651("SLU0", PORT_SLU0, g_pEvents, g_pConsole, g_pCPU);
  //g_pSLU0->AttachInterrupt();
  g_pCPU->InstallDevice(g_pSLU0);

  //   Lastly, create the command line parser.  If a startup script was
  // specified on the command line, now is the time to execute it...
  g_pParser = DBGNEW CCmdParser(PROGRAM, CUI::g_aVerbs, &ConfirmExit, g_pConsole);
  if (!CStandardUI::g_sStartupScript.empty())
    g_pParser->OpenScript(CStandardUI::g_sStartupScript);

  //   This thread now becomes the background task, which loops forever
  // executing operator commands.  Well, almost forever - when the operator
  // types "EXIT" or "QUIT", the command parser exits and then we shutdown
  // the SBC50 program.
  g_pParser->CommandLoop();
  LOGS(DEBUG, "command parser exited");

shutdown:
  // Delete all our global objects.  Once again, the order here is important!
  delete g_pParser;   // the command line parser can go away first
  delete g_pCPU;      // the CPU
  delete g_pMemory;   // the memory object
  if (g_pSLU0   != NULL) delete g_pSLU0;     // console UART
  if (g_pSerial != NULL) delete g_pSerial;   // bit banged serial port
  delete g_pEvents;   // the event queue
  delete g_pLog;      // close the log file
  delete g_pConsole;  // lastly (always lastly!) close the console window
#ifdef _DEBUG
#ifdef _WIN32
  system("pause");
  _CrtDumpMemoryLeaks();
#endif
#endif
  return 0;
}
